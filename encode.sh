#!/bin/bash -e

ffmpeg -i undertale.mp4 -i deltarune.mp4 -f rawvideo -pix_fmt rgba -s 640x120 -r 30 -i <(go run readout.go) -filter_complex 'nullsrc=size=1280x720:rate=30 [base]; [0:v] scale=640:480:flags=neighbor [left]; [1:v] scale=640:480:flags=neighbor [right]; [2:v] scale=1280:240:flags=neighbor [bottom]; [base][left] overlay=shortest=1 [tmp1]; [tmp1][right] overlay=shortest=1:x=640 [tmp2]; [tmp2][bottom] overlay=shortest=1:y=480 [vout]; [0:a]asplit=2[u1][u2]; [1:a]asplit=2[d1][d2]; [u2]lowpass[u3]; [d2]lowpass[d3]; [u1][d3]sidechaincompress[u]; [d1][u3]sidechaincompress[d]; [u][d]amerge=inputs=2,pan=stereo|c0<c0+c1|c1<c2+c3,crossfeed [aout]' -map '[vout]' -map '[aout]' -crf 18 -tune animation -preset veryslow -pix_fmt yuv420p -profile:v main -level 3.1 -movflags +faststart -y -r 30 tas.mp4
